<!DOCTYPE html>

<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car-Bon Monox | Executive AI Research Report</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Plotly.js (Optional use, sticking to Chart.js for consistency/performance but loading just in case of complex need) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #020617;
            /* Slate 950 */
            --surface: #0f172a;
            /* Slate 900 */
            --accent-primary: #38bdf8;
            /* Sky 400 */
            --accent-secondary: #818cf8;
            /* Indigo 400 */
            --danger: #f43f5e;
            /* Rose 500 */
            --text-main: #f8fafc;
            /* Slate 50 */
            --text-muted: #94a3b8;
            /* Slate 400 */
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Chart Container Strict Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            /* Controlled by parent grid usually, but capped here */
            height: 350px;
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }

        /* Glassmorphism Cards */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.1);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(56, 189, 248, 0.3);
            box-shadow: 0 4px 20px -5px rgba(56, 189, 248, 0.15);
        }

        /* AI Shimmer Effect */
        .ai-shimmer {
            background: linear-gradient(90deg, rgba(56, 189, 248, 0) 0%, rgba(56, 189, 248, 0.1) 50%, rgba(56, 189, 248, 0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Logic Flow Connectors */
        .flow-line {
            position: absolute;
            background-color: #334155;
            z-index: 0;
        }
    </style>
</head>

<body class="antialiased selection:bg-sky-500/30">

    <!-- Sticky Navigation -->
    <nav class="sticky top-0 z-50 w-full border-b border-slate-800 bg-slate-950/90 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center font-bold text-white text-lg">
                    C</div>
                <span class="font-bold tracking-tight text-xl">CAR-BON <span class="text-sky-400">MONOX</span></span>
            </div>
            <div class="hidden md:flex gap-8 text-sm font-medium text-slate-400">
                <a href="#overview" class="hover:text-sky-400 transition-colors">Overview</a>
                <a href="#hardware" class="hover:text-sky-400 transition-colors">Hardware</a>
                <a href="#telemetry" class="hover:text-sky-400 transition-colors">Telemetry Analysis</a>
                <a href="#logic" class="hover:text-sky-400 transition-colors">Intervention</a>
            </div>
            <div class="flex items-center gap-2">
                <span class="relative flex h-3 w-3">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-sky-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-sky-500"></span>
                </span>
                <span class="text-xs font-mono text-sky-400">AI SYSTEM ONLINE</span>
            </div>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <main class="relative z-10">

        <!-- Hero & Abstract Section -->
        <section id="overview" class="pt-20 pb-16 px-6 relative overflow-hidden">
            <!-- Background Glow -->
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-sky-500/10 blur-[100px] rounded-full pointer-events-none">
            </div>

            <div class="max-w-5xl mx-auto text-center relative z-10">
                <div
                    class="inline-block px-4 py-1.5 rounded-full border border-indigo-500/30 bg-indigo-500/10 text-indigo-300 text-xs font-bold uppercase tracking-widest mb-6">
                    Research Report v2.1
                </div>
                <h1 class="text-5xl md:text-7xl font-extrabold mb-8 leading-tight">
                    Active Environmental <br>
                    <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-sky-400 via-indigo-400 to-sky-400 animate-pulse">Intervention</span>
                </h1>

                <!-- AI Smart Summary Block -->
                <div class="max-w-3xl mx-auto mb-12">
                    <div class="glass-panel rounded-2xl p-1">
                        <div class="bg-slate-900/80 rounded-xl p-6 md:p-8 text-left relative">
                            <div class="flex justify-between items-center mb-4">
                                <h2
                                    class="text-sm font-bold text-sky-400 uppercase tracking-wider flex items-center gap-2">
                                    <span>üìÑ</span> Abstract Source
                                </h2>
                                <button id="btn-generate-summary"
                                    class="group flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-full text-xs font-bold transition-all shadow-lg shadow-indigo-500/20">
                                    <span class="group-hover:animate-pulse">‚ú®</span> Generate AI Summary
                                </button>
                            </div>

                            <div id="abstract-content"
                                class="text-slate-400 text-sm leading-relaxed border-l-2 border-slate-700 pl-4 mb-4">
                                This report evaluates the critical gap in modern automotive safety protocols regarding
                                stationary vehicle environments. While dynamic safety systems (ADAS) have reached
                                maturity, the risks associated with cabin air quality‚Äîspecifically Carbon Monoxide (CO)
                                toxicity and Hyperthermia‚Äîremain largely unaddressed. This study analyses the Car-Bon
                                Monox architecture: integrating industrial-grade cellular telemetry (SIM7600-QMI) with
                                electrochemical sensing and electromechanical actuation (Remote Window Control) to
                                reduce accidental fatalities.
                            </div>

                            <!-- Hidden AI Output Area -->
                            <div id="ai-summary-container" class="hidden mt-4 pt-4 border-t border-slate-800">
                                <p class="text-xs text-indigo-400 font-mono mb-2">GEMINI ANALYSIS:</p>
                                <p id="ai-summary-text" class="text-white text-base font-medium leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
                    <div class="glass-panel p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-rose-500 mb-1">400+</div>
                        <div class="text-xs text-slate-500 uppercase font-semibold">Annual Deaths (CDC)</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-sky-400 mb-1">&lt;150ms</div>
                        <div class="text-xs text-slate-500 uppercase font-semibold">MQTT Latency</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-indigo-400 mb-1">4G LTE</div>
                        <div class="text-xs text-slate-500 uppercase font-semibold">Connectivity</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-emerald-400 mb-1">35 PPM</div>
                        <div class="text-xs text-slate-500 uppercase font-semibold">Safety Threshold</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hardware Architecture -->
        <section id="hardware" class="py-16 px-6 bg-slate-900/50 border-y border-slate-800">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row gap-12 items-center">
                    <div class="w-full md:w-1/3">
                        <h3 class="text-2xl font-bold text-white mb-4">The Hardware Ecosystem</h3>
                        <p class="text-slate-400 text-sm leading-relaxed mb-6">
                            Unlike passive alarms, Car-Bon Monox is an active intervention system. It pairs a modified
                            MQ-7 Electrochemical array with a SIM7600-QMI LTE gateway.
                        </p>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4 p-3 rounded-lg bg-slate-800/50 border border-slate-700">
                                <div
                                    class="w-10 h-10 rounded bg-sky-900/50 text-sky-400 flex items-center justify-center text-xl">
                                    üì°</div>
                                <div>
                                    <div class="font-bold text-sm text-white">SIM7600-QMI</div>
                                    <div class="text-xs text-slate-500">4G LTE Telemetry & GNSS</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 p-3 rounded-lg bg-slate-800/50 border border-slate-700">
                                <div
                                    class="w-10 h-10 rounded bg-indigo-900/50 text-indigo-400 flex items-center justify-center text-xl">
                                    ‚öõÔ∏è</div>
                                <div>
                                    <div class="font-bold text-sm text-white">ESP32 Core</div>
                                    <div class="text-xs text-slate-500">Dual-core Microcontroller</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 p-3 rounded-lg bg-slate-800/50 border border-slate-700">
                                <div
                                    class="w-10 h-10 rounded bg-rose-900/50 text-rose-400 flex items-center justify-center text-xl">
                                    ‚ö°</div>
                                <div>
                                    <div class="font-bold text-sm text-white">Relay Driver</div>
                                    <div class="text-xs text-slate-500">Physical Window Actuation</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CSS Diagram -->
                    <div class="w-full md:w-2/3 bg-slate-950 rounded-2xl border border-slate-800 p-8 relative">
                        <div
                            class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiMzMzQxNTUiIG9wYWNpdHk9IjAuMiIvPjwvc3ZnPg==')] opacity-20">
                        </div>

                        <div class="grid grid-cols-3 gap-4 relative z-10 text-center">
                            <!-- Sensors -->
                            <div class="flex flex-col gap-4 justify-center">
                                <div class="p-4 rounded-lg border border-indigo-500/30 bg-indigo-500/10">
                                    <div class="text-2xl mb-1">üå°Ô∏è</div>
                                    <div class="text-xs font-bold text-indigo-300">Temp/Hum</div>
                                </div>
                                <div class="p-4 rounded-lg border border-sky-500/30 bg-sky-500/10">
                                    <div class="text-2xl mb-1">üí®</div>
                                    <div class="text-xs font-bold text-sky-300">MQ-7 (CO)</div>
                                </div>
                            </div>

                            <!-- Core -->
                            <div class="flex items-center justify-center">
                                <div
                                    class="w-full aspect-square rounded-full border-2 border-slate-700 bg-slate-900 flex flex-col items-center justify-center relative shadow-2xl shadow-sky-500/10">
                                    <div class="absolute inset-0 rounded-full border border-sky-500/20 animate-pulse">
                                    </div>
                                    <div class="text-xs font-mono text-slate-500 mb-1">MCU</div>
                                    <div class="font-bold text-white text-lg">ESP32</div>
                                    <div class="text-[10px] text-sky-400 mt-1">Processing</div>
                                </div>
                            </div>

                            <!-- Outputs -->
                            <div class="flex flex-col gap-4 justify-center">
                                <div class="p-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10">
                                    <div class="text-2xl mb-1">‚òÅÔ∏è</div>
                                    <div class="text-xs font-bold text-emerald-300">Cloud DB</div>
                                </div>
                                <div class="p-4 rounded-lg border border-rose-500/30 bg-rose-500/10">
                                    <div class="text-2xl mb-1">üöó</div>
                                    <div class="text-xs font-bold text-rose-300">Window Motor</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Telemetry Analysis & AI Diagnostic -->
        <section id="telemetry" class="py-16 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6">
                    <div>
                        <h3 class="text-3xl font-bold text-white mb-2">Telemetry Stream Analysis</h3>
                        <p class="text-slate-400 text-sm max-w-2xl">
                            Visualizing real-time data from the provided JSON dataset. The system tracks both calibrated
                            PPM (ESP32) and high-sensitivity raw ADC values (Rasp-Pi).
                        </p>
                    </div>

                    <!-- AI Diagnostic Button -->
                    <button id="btn-run-diagnostic"
                        class="glass-panel px-6 py-3 rounded-lg flex items-center gap-3 hover:bg-slate-800 transition-colors group border-l-4 border-l-sky-500">
                        <div class="flex flex-col text-left">
                            <span class="text-[10px] text-sky-400 font-bold uppercase tracking-wider">Gemini
                                Engine</span>
                            <span class="text-sm font-bold text-white group-hover:text-sky-300 transition-colors">Run
                                Safety Diagnostic</span>
                        </div>
                        <span class="text-xl">ü©∫</span>
                    </button>
                </div>

                <!-- Diagnostic Output Area -->
                <div id="diagnostic-result"
                    class="hidden mb-12 p-6 rounded-xl bg-gradient-to-r from-sky-900/20 to-slate-900 border border-sky-500/30 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-sky-500"></div>
                    <div class="flex gap-4">
                        <div class="text-2xl mt-1">ü§ñ</div>
                        <div>
                            <h4 class="text-sky-400 font-bold text-sm uppercase mb-2">AI Assessment Report</h4>
                            <p id="diagnostic-text" class="text-slate-200 text-sm leading-relaxed"></p>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                    <!-- Chart 1: ESP32 Calibrated -->
                    <div class="glass-panel p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h4 class="font-bold text-white">Calibrated CO Levels</h4>
                                <div class="text-xs text-slate-500">Source: ESP32 | Unit: PPM</div>
                            </div>
                            <div class="w-3 h-3 rounded-full bg-sky-400"></div>
                        </div>
                        <div class="chart-container">
                            <canvas id="espChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Rasp-Pi Raw -->
                    <div class="glass-panel p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h4 class="font-bold text-white">Raw Sensor Dynamics</h4>
                                <div class="text-xs text-slate-500">Source: Rasp-Pi | Unit: ADC (16-bit)</div>
                            </div>
                            <div class="w-3 h-3 rounded-full bg-indigo-400"></div>
                        </div>
                        <div class="chart-container">
                            <canvas id="piChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 3: Correlation (Full Width) -->
                    <div class="lg:col-span-2 glass-panel p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h4 class="font-bold text-white">Environmental Correlation</h4>
                                <div class="text-xs text-slate-500">Temperature vs. CO Concentration Sensitivity</div>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span
                                    class="px-2 py-1 rounded bg-rose-500/20 text-rose-300 border border-rose-500/30">High
                                    Risk Zone</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Logic Flow -->
        <section id="logic" class="py-16 px-6 bg-slate-900/50 border-t border-slate-800">
            <div class="max-w-6xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-10 text-center">Intervention Decision Matrix</h3>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 relative">
                    <!-- Connecting Line (Desktop) -->
                    <div class="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-slate-800 -z-0 -translate-y-1/2">
                    </div>

                    <!-- Step 1 -->
                    <div
                        class="relative z-10 glass-panel p-6 rounded-xl text-center group hover:-translate-y-2 transition-transform bg-slate-950">
                        <div
                            class="w-10 h-10 mx-auto rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center font-bold text-slate-400 mb-4 group-hover:border-sky-500 group-hover:text-sky-500 transition-colors">
                            1</div>
                        <h5 class="font-bold text-white mb-2">Monitor</h5>
                        <p class="text-xs text-slate-400">Continuous sampling (5s intervals). Baselines established.</p>
                    </div>

                    <!-- Step 2 -->
                    <div
                        class="relative z-10 glass-panel p-6 rounded-xl text-center group hover:-translate-y-2 transition-transform bg-slate-950">
                        <div
                            class="w-10 h-10 mx-auto rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center font-bold text-slate-400 mb-4 group-hover:border-indigo-500 group-hover:text-indigo-500 transition-colors">
                            2</div>
                        <h5 class="font-bold text-white mb-2">Validate</h5>
                        <p class="text-xs text-slate-400">Threshold check (>35 PPM). False positive filtering.</p>
                    </div>

                    <!-- Step 3 -->
                    <div
                        class="relative z-10 glass-panel p-6 rounded-xl text-center group hover:-translate-y-2 transition-transform bg-slate-950">
                        <div
                            class="w-10 h-10 mx-auto rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center font-bold text-slate-400 mb-4 group-hover:border-amber-500 group-hover:text-amber-500 transition-colors">
                            3</div>
                        <h5 class="font-bold text-white mb-2">Alert</h5>
                        <p class="text-xs text-slate-400">MQTT Broadcast to App. Cabin Buzzer activation.</p>
                    </div>

                    <!-- Step 4 -->
                    <div
                        class="relative z-10 glass-panel p-6 rounded-xl text-center group hover:-translate-y-2 transition-transform bg-slate-950">
                        <div
                            class="w-10 h-10 mx-auto rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center font-bold text-slate-400 mb-4 group-hover:border-rose-500 group-hover:text-rose-500 transition-colors">
                            4</div>
                        <h5 class="font-bold text-white mb-2">Intervene</h5>
                        <p class="text-xs text-slate-400">Relay fires. Windows lower 10cm. V2X Signal sent.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Regulatory & Footer -->
        <section class="py-12 px-6 border-t border-slate-800">
            <div class="max-w-4xl mx-auto text-center">
                <h4 class="text-lg font-bold text-slate-300 mb-4">Regulatory Roadmap 2030</h4>
                <p class="text-slate-500 text-sm mb-8">
                    Recommending DOT/NHTSA integration of "Internal Environmental Monitoring" into 5-Star Safety
                    Ratings.
                </p>
                <div class="flex justify-center gap-4 text-xs text-slate-600">
                    <span>¬© 2026 Car-Bon Monox Research</span>
                    <span>‚Ä¢</span>
                    <span>Gunpreet Singh</span>
                    <span>‚Ä¢</span>
                    <span>ESP32 / SIM7600 Architecture</span>
                </div>
            </div>
        </section>

    </main>

    <!-- Floating AI Chat Assistant -->
    <div class="fixed bottom-6 right-6 z-50">
        <!-- Chat Window -->
        <div id="chat-window"
            class="hidden w-80 md:w-96 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col transition-all origin-bottom-right transform scale-95 opacity-0">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-lg">‚ú®</span>
                    <span class="font-bold text-white text-sm">Research Assistant</span>
                </div>
                <button id="btn-close-chat" class="text-slate-500 hover:text-white">&times;</button>
            </div>

            <div id="chat-history" class="h-80 overflow-y-auto p-4 space-y-3 bg-slate-950">
                <div class="flex gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-sky-900/50 flex items-center justify-center text-xs text-sky-400 flex-shrink-0">
                        AI</div>
                    <div
                        class="bg-slate-900 border border-slate-800 p-3 rounded-tr-xl rounded-b-xl text-xs text-slate-300">
                        Hello. I have analyzed the Car-Bon Monox report. Ask me about hardware specs, CO thresholds, or
                        safety logic.
                    </div>
                </div>
            </div>

            <div class="p-3 bg-slate-900 border-t border-slate-800">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Ask a question..."
                        class="flex-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-sky-500 transition-colors">
                    <button id="btn-send-chat"
                        class="bg-sky-600 hover:bg-sky-500 text-white p-2 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Toggle Button -->
        <button id="btn-toggle-chat"
            class="w-14 h-14 bg-sky-600 hover:bg-sky-500 rounded-full shadow-xl flex items-center justify-center text-2xl transition-transform hover:scale-110">
            ‚ú®
        </button>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. DATA PREPARATION (Based on provided JSON snippet & report) ---

        // Calibrated Data (ESP32) - Extracted from snippet
        // Timestamps are Unix. 1420054200 approx.
        const espData = [
            { t: '10:00', v: 9.29 },
            { t: '11:00', v: 13.28 },
            { t: '12:00', v: 29.67 }, // High point
            { t: '13:00', v: 21.76 },
            { t: '14:00', v: 26.19 },
            { t: '15:00', v: 11.04 },
            { t: '16:00', v: 8.50 }
        ];

        // Raw Data (Rasp-Pi) - High density values
        const piData = [
            { t: '0s', v: 11027, temp: 1.97 },
            { t: '5s', v: 8060, temp: 2.1 },
            { t: '10s', v: 8039, temp: 2.3 },
            { t: '15s', v: 10355, temp: 2.8 },
            { t: '20s', v: 14898, temp: 3.5 }, // Peak
            { t: '25s', v: 6973, temp: 4.1 },
            { t: '30s', v: 7500, temp: 4.5 },
            { t: '35s', v: 12000, temp: 5.2 },
            { t: '40s', v: 16500, temp: 6.0 }
        ];

        // --- 2. GEMINI API INTEGRATION ---

        const apiKey = ""; // Runtime Environment Key
        const modelId = "gemini-2.5-flash-preview-09-2025";

        async function callGemini(prompt, systemInstruction = "You are a senior automotive safety researcher and data analyst.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            let delay = 1000;
            for (let i = 0; i < 3; i++) { // Retry logic
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis unavailable.";
                } catch (e) {
                    if (i === 2) return "System Offline: Unable to connect to AI Research Engine.";
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        // --- 3. CHART CONFIGURATION ---

        // Label Wrapping (Mandatory)
        const wrap = (str) => {
            if (str.length > 16) return str.match(/.{1,16}/g) || [str];
            return str;
        };

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    backgroundColor: '#0f172a',
                    borderColor: '#38bdf8',
                    borderWidth: 1,
                    titleColor: '#38bdf8',
                    callbacks: {
                        title: (items) => {
                            const label = items[0].label;
                            return Array.isArray(label) ? label.join(' ') : label;
                        }
                    }
                },
                legend: { labels: { color: '#94a3b8' } }
            },
            scales: {
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        };

        // Render Charts
        window.addEventListener('load', () => {

            // 1. ESP32 Chart
            const ctxEsp = document.getElementById('espChart').getContext('2d');
            new Chart(ctxEsp, {
                type: 'line',
                data: {
                    labels: espData.map(d => d.t),
                    datasets: [{
                        label: 'Calibrated CO (PPM)',
                        data: espData.map(d => d.v),
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: commonOptions
            });

            // 2. Pi Chart
            const ctxPi = document.getElementById('piChart').getContext('2d');
            new Chart(ctxPi, {
                type: 'bar',
                data: {
                    labels: piData.map(d => d.t),
                    datasets: [{
                        label: 'Raw ADC Value',
                        data: piData.map(d => d.v),
                        backgroundColor: '#818cf8',
                        borderRadius: 4
                    }]
                },
                options: commonOptions
            });

            // 3. Correlation Chart
            const ctxCorr = document.getElementById('correlationChart').getContext('2d');
            new Chart(ctxCorr, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Temp vs Raw CO',
                        data: piData.map(d => ({ x: d.temp, y: d.v })),
                        backgroundColor: (ctx) => {
                            const val = ctx.raw?.y;
                            return val > 14000 ? '#f43f5e' : '#38bdf8'; // Red if high
                        },
                        pointRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Temperature (¬∞C)', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            title: { display: true, text: 'Raw ADC', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        });

        // --- 4. INTERACTION LOGIC ---

        // Feature: Smart Summary
        const btnSummary = document.getElementById('btn-generate-summary');
        const summaryContainer = document.getElementById('ai-summary-container');
        const summaryText = document.getElementById('ai-summary-text');

        btnSummary.addEventListener('click', async () => {
            summaryContainer.classList.remove('hidden');
            summaryText.innerHTML = `<span class="animate-pulse">Analyzing document structure...</span>`;
            btnSummary.disabled = true;
            btnSummary.classList.add('opacity-50');

            const abstract = document.getElementById('abstract-content').innerText;
            const prompt = `Summarize this technical abstract into 2 concise sentences for a non-technical executive, focusing on the problem and the solution: "${abstract}"`;

            const result = await callGemini(prompt);
            summaryText.innerText = result;
            btnSummary.disabled = false;
            btnSummary.classList.remove('opacity-50');
        });

        // Feature: AI Diagnostic
        const btnDiagnostic = document.getElementById('btn-run-diagnostic');
        const diagResult = document.getElementById('diagnostic-result');
        const diagText = document.getElementById('diagnostic-text');

        btnDiagnostic.addEventListener('click', async () => {
            diagResult.classList.remove('hidden');
            diagText.innerHTML = "Processing telemetry streams...";

            // Construct context from actual chart data
            const peakPPM = Math.max(...espData.map(d => d.v));
            const peakADC = Math.max(...piData.map(d => d.v));

            const prompt = `Analyze these sensor readings from the Car-Bon Monox device:
        1. Peak Calibrated CO: ${peakPPM} PPM (Note: OSHA limit is 35 PPM).
        2. Peak Raw ADC: ${peakADC} (16-bit sensor).
        
        Is this dangerous? What state should the device be in (Monitor, Alert, or Intervene)? Explain briefly to a Fleet Manager.`;

            const result = await callGemini(prompt, "You are an industrial safety officer.");
            diagText.innerText = result;
        });

        // Feature: Chat Assistant
        const chatWindow = document.getElementById('chat-window');
        const btnToggle = document.getElementById('btn-toggle-chat');
        const btnClose = document.getElementById('btn-close-chat');
        const chatInput = document.getElementById('chat-input');
        const btnSend = document.getElementById('btn-send-chat');
        const chatHistory = document.getElementById('chat-history');

        // Toggle visibility
        btnToggle.addEventListener('click', () => {
            chatWindow.classList.toggle('hidden');
            setTimeout(() => {
                chatWindow.classList.toggle('opacity-0');
                chatWindow.classList.toggle('scale-95');
            }, 10);
        });

        btnClose.addEventListener('click', () => {
            chatWindow.classList.add('opacity-0', 'scale-95');
            setTimeout(() => chatWindow.classList.add('hidden'), 300);
        });

        // Chat Logic
        const addMessage = (text, isUser) => {
            const div = document.createElement('div');
            div.className = "flex gap-3 " + (isUser ? "flex-row-reverse" : "");

            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs flex-shrink-0 ${isUser ? 'bg-indigo-600 text-white' : 'bg-sky-900/50 text-sky-400'}`;
            avatar.innerText = isUser ? 'U' : 'AI';

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl text-xs max-w-[80%] ${isUser ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-900 border border-slate-800 text-slate-300 rounded-tl-none'}`;
            bubble.innerText = text;

            div.appendChild(avatar);
            div.appendChild(bubble);
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        const handleSend = async () => {
            const query = chatInput.value.trim();
            if (!query) return;

            addMessage(query, true);
            chatInput.value = '';

            // Add loading state
            const loadingId = 'loading-' + Date.now();
            const loadDiv = document.createElement('div');
            loadDiv.id = loadingId;
            loadDiv.className = "flex gap-3";
            loadDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-sky-900/50 flex items-center justify-center text-xs text-sky-400">AI</div><div class="p-3 rounded-xl bg-slate-900 border border-slate-800 text-slate-500 text-xs italic">Consulting research...</div>`;
            chatHistory.appendChild(loadDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const prompt = `Context: Technical report for 'Car-Bon Monox' safety device. 
        Specs: SIM7600-QMI (4G), MQ-7 Sensor, Window Actuation Relay. 
        Goal: Prevent CO poisoning in stationary cars.
        User Question: ${query}`;

            const response = await callGemini(prompt);

            document.getElementById(loadingId).remove();
            addMessage(response, false);
        };

        btnSend.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    </script>
</body>

</html>